<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Trip Task Check-In Bot</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
/* ======================================================================
   THEME + BASE
====================================================================== */
:root{
  --bg:#05070b;
  --card:#0f1420;
  --card-soft:#111827;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --accent2:#22d3ee;
  --border:#1f2933;
  --danger:#ef4444;
  --ok:#10b981;
  --shadow:0 18px 45px rgba(0,0,0,.6);
  --radius-lg:18px;
  --radius-sm:10px;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  min-height:100vh;
  padding:24px;
  background:
    radial-gradient(950px 650px at 5% -10%, #1e293b 0%, transparent 60%),
    radial-gradient(950px 650px at 110% 110%, #0f172a 0%, transparent 55%),
    var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Inter","Segoe UI",Roboto,Arial,sans-serif;
}

.app-shell{max-width:1040px;margin:0 auto}

/* ======================================================================
   HEADER
====================================================================== */
header{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:16px;
  margin-bottom:20px;
}
header h1{font-size:26px;font-weight:650;margin-bottom:4px}
header p{font-size:13px;color:var(--muted)}

.pill-auth{
  padding:6px 12px;border-radius:999px;
  background:rgba(16,185,129,.08);
  color:#bbf7d0;font-size:12px;
  display:flex;align-items:center;gap:6px;
}
.pill-auth-dot{
  width:8px;height:8px;border-radius:50%;
  background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.25);
}

/* ======================================================================
   CARD
====================================================================== */
.card{
  background:radial-gradient(circle at top left,rgba(148,163,184,.12),transparent 55%),var(--card);
  border:1px solid rgba(30,64,175,.55);
  border-radius:var(--radius-lg);
  padding:20px;
  margin-bottom:18px;
  box-shadow:var(--shadow);
}
.card-header{display:flex;justify-content:space-between;margin-bottom:10px}
.card-title{font-size:14px;font-weight:600}
.card-subtitle{font-size:12px;color:var(--muted)}

.row{display:flex;flex-wrap:wrap;gap:10px}
.input-shell{flex:1 1 240px}
label.small-label{font-size:11px;color:var(--muted)}
input{
  width:100%;
  padding:9px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#0f172a;
  color:var(--text);
}
input:focus{outline:none;border-color:var(--accent2)}

.btn-bar{display:flex;gap:8px}
.btn{
  border-radius:999px;padding:9px 16px;
  border:1px solid transparent;
  background:transparent;
  color:var(--text);
  cursor:pointer;
}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
}
.btn-secondary{
  background:#0f172a;border-color:var(--border);
}
.btn-ghost{
  border:1px solid rgba(148,163,184,.25);
  color:var(--muted);
}

/* ======================================================================
   STATUS
====================================================================== */
.status-row{
  display:flex;justify-content:space-between;
  font-size:12px;color:var(--muted);
}
.status-dot{
  width:7px;height:7px;border-radius:50%;background:#64748b;margin-right:6px;
}
.status-dot.is-busy{
  background:var(--accent2);
  box-shadow:0 0 0 4px rgba(34,211,238,.15);
}

/* ======================================================================
   TASK LIST
====================================================================== */
.tasks-wrapper{display:grid;gap:12px}

.task-section{
  background:var(--card-soft);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  padding:12px;
}
.task-section-header{
  display:flex;justify-content:space-between;
}
.task-section-title{font-size:12px;font-weight:600}
.task-section-count{font-size:11px;color:var(--muted)}

.task-row{
  display:flex;
  align-items:center;
  gap:10px;
  padding:6px;
  border-radius:8px;
  cursor:pointer;
}
.task-row:hover{
  background:rgba(30,64,175,.16);
}

/* Bubbles */
.bubble{
  width:18px;height:18px;border-radius:50%;
  border:2px solid #64748b;
  position:relative;
  flex:0 0 18px;
  transition:.15s;
}
.bubble-empty{ border-color:#64748b; }
.bubble-filled{
  border-color:var(--accent2);
  box-shadow:0 0 8px rgba(34,211,238,.6), inset 0 0 3px rgba(34,211,238,.6);
}
.bubble-filled::after{
  content:"";position:absolute;inset:3px;
  border-radius:50%;background:var(--accent2);opacity:1;
  box-shadow:0 0 4px rgba(34,211,238,.9);
}

.task-label{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.file-badge{
  font-size:10px;
  padding:2px 6px;
  border-radius:6px;
  background:#1e293b;
  border:1px solid var(--border);
  color:var(--accent2);
  margin-left:6px;
}

/* ======================================================================
   FILE UPLOAD PANEL ‚Äî Global
====================================================================== */
#upload-panel{
  margin-top:14px;
  padding:14px;
  border-radius:var(--radius-sm);
  border:1px solid var(--border);
  background:#0b1120;
  display:none;
}
#upload-panel h3{font-size:13px;margin-bottom:8px}
#upload-panel .need-file{font-size:12px;color:var(--muted);margin-bottom:6px}
#upload-panel input[type=file]{margin-top:6px}
#upload-panel-success{font-size:11px;color:var(--ok);margin-top:6px;display:none}

/* ======================================================================
   RESULTS
====================================================================== */
.results-box{
  border:1px solid var(--border);
  background:#020617;
  border-radius:var(--radius-sm);
  padding:10px;font-size:11px;
  font-family:monospace;
  white-space:pre-wrap;
}
.error{color:var(--danger);font-size:11px;margin-top:6px}
.empty{color:var(--muted)}
</style>
</head>

<body>
<div class="app-shell">

<header>
  <div>
    <h1>Trip Task Check-In Bot</h1>
    <p>Review and toggle Delivery / Pickup / Linehaul check-ins</p>
  </div>
  <div class="pill-auth">
    <span class="pill-auth-dot"></span> Authenticated
  </div>
</header>

<!-- ==============================================================
     TRIP SEARCH
============================================================== -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Trip Search</div>
      <div class="card-subtitle">Enter FMS trip #</div>
    </div>
  </div>

  <div class="row">
    <div class="input-shell">
      <label class="small-label">Trip #</label>
      <input id="trip-input" placeholder="B01KJY"/>
    </div>

    <div class="btn-bar">
      <button id="btn-load" class="btn btn-primary">üîç Load Tasks</button>
      <button id="btn-apply" class="btn btn-secondary" disabled>‚úÖ Apply</button>
      <button id="btn-clear" class="btn btn-ghost">üßπ Clear</button>
    </div>
  </div>

  <div class="status-row">
    <div><span id="status-dot" class="status-dot"></span><span id="status-text">Idle.</span></div>
    <div id="elapsed-text">Elapsed: 0.0s</div>
  </div>
</section>


<!-- ==============================================================
     TASK LIST + FILE STATUS
============================================================== -->
<section class="card">
  <div class="card-header">
    <div>
      <div class="card-title">Tasks Checklist</div>
      <div class="card-subtitle">Click bubbles to toggle / file status shown</div>
    </div>
  </div>

  <div class="tasks-wrapper">

    <div class="task-section">
      <div class="task-section-header">
        <div class="task-section-title">Delivery Tasks</div>
        <div class="task-section-count" id="count-delivery">(0)</div>
      </div>
      <div id="list-delivery"></div>
    </div>

    <div class="task-section">
      <div class="task-section-header">
        <div class="task-section-title">Pickup Tasks</div>
        <div class="task-section-count" id="count-pickup">(0)</div>
      </div>
      <div id="list-pickup"></div>
    </div>

    <div class="task-section">
      <div class="task-section-header">
        <div class="task-section-title">Linehaul Tasks</div>
        <div class="task-section-count" id="count-linehaul">(0)</div>
      </div>
      <div id="list-linehaul"></div>
    </div>

  </div>

  <div id="error-text" class="error" style="display:none;"></div>

  <!-- GLOBAL UPLOAD PANEL -->
  <div id="upload-panel">
    <h3>Upload Required File</h3>
    <div id="upload-need" class="need-file"></div>
    <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.pdf"/>
    <button id="btn-upload" class="btn btn-primary" style="margin-top:8px;">‚¨Ü Upload</button>
    <div id="upload-panel-success"></div>
  </div>
</section>


<!-- ==============================================================
     RESULTS
============================================================== -->
<section class="card">
  <div class="card-header">
    <div class="card-title">Results</div>
  </div>
  <div id="results-box" class="results-box empty">No results yet.</div>
</section>


<script>
/* ======================================================================
   STATE
====================================================================== */
let tasks=[], tripNo="", fileMap={}, pendingUploadTask=null;

const el={
  tripInput:document.getElementById("trip-input"),
  btnLoad:document.getElementById("btn-load"),
  btnApply:document.getElementById("btn-apply"),
  btnClear:document.getElementById("btn-clear"),
  statusDot:document.getElementById("status-dot"),
  statusText:document.getElementById("status-text"),
  listDelivery:document.getElementById("list-delivery"),
  listPickup:document.getElementById("list-pickup"),
  listLinehaul:document.getElementById("list-linehaul"),
  resultsBox:document.getElementById("results-box"),
  errorText:document.getElementById("error-text"),
  uploadPanel:document.getElementById("upload-panel"),
  uploadNeed:document.getElementById("upload-need"),
  fileInput:document.getElementById("file-input"),
  uploadBtn:document.getElementById("btn-upload"),
  uploadSuccess:document.getElementById("upload-panel-success"),
  countDelivery:document.getElementById("count-delivery"),
  countPickup:document.getElementById("count-pickup"),
  countLinehaul:document.getElementById("count-linehaul"),
};

const clean=v=>String(v??"").trim();
const isComplete=s=>clean(s).toLowerCase()==="complete";

function setStatus(t,b){
  el.statusText.textContent=t;
  el.statusDot.classList.toggle("is-busy",b);
}
function reset(){
  tasks=[];
  fileMap={};
  pendingUploadTask=null;

  el.uploadPanel.style.display="none";
  el.uploadSuccess.style.display="none";
  el.uploadNeed.textContent="";
  el.fileInput.value="";

  render();
  el.resultsBox.textContent="No results yet.";
  el.resultsBox.classList.add("empty");
}

/* ======================================================================
   API
====================================================================== */

async function apiCall(payload){
  const r=await fetch("/api/fms",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  return r.json();
}

async function fetchTasks(trip){
  return apiCall({ action:"getTasks", tripNo:trip });
}

async function fetchFiles(trip){
  return apiCall({ action:"getTripFiles", tripNo:trip });
}

async function uploadFile(task, file){
  const body = new FormData();
  body.append("file", file);

  return apiCall({
    action:"uploadFile",
    task,
    tripNo,
    fileName:file.name
  });
}

async function sendCheckin(task){
  return apiCall({
    action:"checkin",
    tripNo,
    task
  });
}

async function sendUndo(task){
  return apiCall({
    action:"undo",
    tripNo,
    task
  });
}

/* ======================================================================
   NORMALIZE
====================================================================== */
function normalizeTasks(raw){
  return raw.map(t=>{
    const o={
      do:clean(t.do),
      pro:clean(t.pro),
      pu:clean(t.pu),
      taskNo:t.taskNo,
      taskType:clean(t.taskType),
      status:clean(t.status),
      originalComplete:isComplete(t.status),
      currentComplete:isComplete(t.status),
      fileTypeNeeded:null,
      fileFoundUrl:null
    };
    return o;
  });
}

function applyFilesToTasks(){
  for(const t of tasks){
    const key = t.pro || t.pu || t.do;
    const files = fileMap[key] || [];

    if(t.taskType.startsWith("Del")){
      const pod = files.find(f=>f.type==="POD");
      if(pod){
        t.fileTypeNeeded=null;
        t.fileFoundUrl=pod.url;
      } else {
        t.fileTypeNeeded="POD";
      }
    }

    if(t.taskType.startsWith("Pick")){
      const bol = files.find(f=>f.type==="BOL");
      if(bol){
        t.fileTypeNeeded=null;
        t.fileFoundUrl=bol.url;
      } else {
        t.fileTypeNeeded="BOL";
      }
    }
  }
}

/* ======================================================================
   RENDER
====================================================================== */
function renderSection(elm,list){
  elm.innerHTML="";

  if(!list.length){
    elm.innerHTML='<div class="no-tasks">None found.</div>';
    return;
  }

  list.forEach(t=>{
    const row=document.createElement("div");
    row.className="task-row";

    const bubble=document.createElement("div");
    bubble.className="bubble "+(t.currentComplete?"bubble-filled":"bubble-empty");

    const label=document.createElement("div");
    label.className="task-label";
    label.textContent = t.taskType.includes("Line")
      ? `LH# ${t.do}`
      : `DO ${t.do} | PRO ${t.pro||"‚Äî"} | PU ${t.pu||"‚Äî"}`;

    row.appendChild(bubble);
    row.appendChild(label);

    if(t.fileFoundUrl){
      const fb=document.createElement("a");
      fb.href=t.fileFoundUrl;
      fb.target="_blank";
      fb.className="file-badge";
      fb.textContent=t.taskType.startsWith("Del")?"POD":"BOL";
      row.appendChild(fb);

    } else if(t.fileTypeNeeded){
      const fb=document.createElement("span");
      fb.className="file-badge";

      // FIXED: var() usage in JS
      fb.style.color = getComputedStyle(document.documentElement)
          .getPropertyValue("--danger");

      fb.textContent=`Missing ${t.fileTypeNeeded}`;
      row.appendChild(fb);
    }

    row.onclick=()=>{
      t.currentComplete=!t.currentComplete;
      bubble.classList.toggle("bubble-filled",t.currentComplete);
      bubble.classList.toggle("bubble-empty",!t.currentComplete);
    };

    elm.appendChild(row);
  });
}

function render(){
  const d=tasks.filter(t=>t.taskType.startsWith("Del"));
  const p=tasks.filter(t=>t.taskType.startsWith("Pick"));
  const l=tasks.filter(t=>t.taskType.toLowerCase().includes("line"));

  renderSection(el.listDelivery,d);
  renderSection(el.listPickup,p);
  renderSection(el.listLinehaul,l);

  el.countDelivery.textContent=`(${d.length})`;
  el.countPickup.textContent=`(${p.length})`;
  el.countLinehaul.textContent=`(${l.length})`;
}

/* ======================================================================
   APPLY BUTTON LOGIC
====================================================================== */
async function processApply(){

  el.resultsBox.textContent="";
  el.resultsBox.classList.remove("empty");

  for(const t of tasks){

    if(t.currentComplete === t.originalComplete){
      continue;
    }

    if(t.currentComplete){
      if(t.fileTypeNeeded){
        pendingUploadTask=t;
        el.uploadPanel.style.display="block";
        el.uploadNeed.textContent=`${t.fileTypeNeeded} required for DO ${t.do} | PRO ${t.pro}`;
        setStatus("Upload required before check-in",false);
        return;
      }

      await sendCheckin(t);
      el.resultsBox.textContent+=
        `‚úî CHECK-IN ‚Üí DO ${t.do} | PRO ${t.pro} | PU ${t.pu}\n`;

    } else {
      await sendUndo(t);
      el.resultsBox.textContent+=
        `‚Ü© UNDO ‚Üí DO ${t.do} | PRO ${t.pro} | PU ${t.pu}\n`;
    }

  }

  setStatus("Done",false);
}

/* ======================================================================
   FILE UPLOAD HANDLER
====================================================================== */
el.uploadBtn.onclick=async()=>{

  if(!pendingUploadTask) return;

  const file = el.fileInput.files[0];
  if(!file){
    alert("Choose a file first.");
    return;
  }

  const up=await uploadFile(pendingUploadTask,file);

  if(up?.success){

    el.uploadSuccess.textContent="File uploaded successfully. Click Apply again.";
    el.uploadSuccess.style.display="block";

    pendingUploadTask.fileTypeNeeded=null;
    pendingUploadTask.fileFoundUrl=up.url;

    el.uploadPanel.style.display="none";

  } else {
    el.uploadSuccess.style.display="block";

    // FIXED: var() usage in JS
    el.uploadSuccess.style.color = getComputedStyle(document.documentElement)
        .getPropertyValue("--danger");

    el.uploadSuccess.textContent="Upload failed.";
  }
};

/* ======================================================================
   EVENTS
====================================================================== */

el.btnLoad.onclick=async()=>{
  tripNo=clean(el.tripInput.value);
  if(!tripNo)return;

  reset();
  setStatus(`Loading Trip ${tripNo}‚Ä¶`,true);

  const tData=await fetchTasks(tripNo);
  const fData=await fetchFiles(tripNo);

  tasks=normalizeTasks(tData.tasks||[]);

  fileMap = {};
  (fData.files||[]).forEach(f=>{
    const key=f.pro || f.tracking_no;
    if(!fileMap[key]) fileMap[key]=[];
    fileMap[key].push({
      type:f.file_type,
      url:f.file_public_url
    });
  });

  applyFilesToTasks();
  render();

  el.btnApply.disabled=!tasks.length;
  setStatus("Ready",false);
};

el.btnApply.onclick=processApply;

el.btnClear.onclick=()=>{
  el.tripInput.value="";
  reset();
  setStatus("Idle",false);
};

setStatus("Idle.");
</script>

</body>
</html>
